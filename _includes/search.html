<div id="bcc-search-wrapper">

    <div id="search_suggestions_wrapper">
        <label for="search_code_input"> Search BCC-Code Github </label>

        <input type="text" name="searchCode"
               id="search_code_input"
               placeholder="Search bcc-code"
               onkeyup="doubleFunction()"/>
        <div id="search_suggestions-section">
            <ul>
                <li class="search_button">
                    <a onclick="searchOnClickFunction()" class="btn-search">
                        Search on Github
                    </a>
                </li>
                <li>
                    <ul id="search_suggestions"></ul>
                </li>


            </ul>

        </div>

    </div>
</div>

<script type="module"></script>

<script>

    const doubleFunction = () => {
        autoComplete();
        checkInputValue();
    }

    function autoComplete() {
        let input, filter, ul, li, a, i;
        input = document.getElementById("search_code_input");
        filter = input.value.toUpperCase();
        ul = document.getElementById("search_suggestions");
        li = ul.getElementsByTagName("li");

        for (i = 0; i < li.length; i++) {

            a = li[i].getElementsByTagName("a")[0];
            if (a.innerHTML.toUpperCase().indexOf(filter) > -1) {
                li[i].style.display = "";
            } else {
                li[i].style.display = "none";
            }
        }
    }

    function checkInputValue() {
        const searchInputElement = document.getElementById("search_code_input");

        if (searchInputElement.value === "" || searchInputElement.value === " ") {
            searchInputElement.setAttribute("class", "");
        } else {
            searchInputElement.setAttribute("class", "input_searching");
        }


    }

    function searchOnClickFunction() {

        const searchCode = document.getElementById("search_code_input").value;
        window.location.href = "https://github.com/search?q=org%3Abcc-code+" + searchCode;

    }

    async function listMarkdownFiles() {

        let newElementsLocation = document.getElementById("search_suggestions");

        if (sessionStorage.length !== 0) {
            console.log("There is data in the session!");

            for (let searchNumber = 1; searchNumber <= sessionStorage.length; searchNumber++) {

                let data = sessionStorage[searchNumber];

                data = JSON.parse(data)

                let firstKey = Object.keys(data)[0];
                let secondKey = Object.keys(data)[1];
                let thirdKey = Object.keys(data)[2];

                let markdownRepositoryName = data[firstKey];                
                let markdownFileName = data[secondKey];
                let markdownFilePath = data[thirdKey];
                
                const sliceFilePath = markdownFilePath.slice(0, -3);

                const markdownPageUrl = `/${markdownRepositoryName}/${sliceFilePath}.html`;

                let createListItem = document.createElement("li");
                let searchSuggestion = document.createElement("a");
                let searchSuggestionRepository = document.createElement("span");

                createListItem.className = "search_suggestion";

                searchSuggestion.setAttribute("href", `${markdownPageUrl}`);
                searchSuggestion.innerText = `${markdownFileName}`;

                searchSuggestionRepository.className = "search_suggestion";
                searchSuggestionRepository.innerText = `${markdownRepositoryName}`;

                newElementsLocation.appendChild(createListItem).appendChild(searchSuggestion);
                newElementsLocation.appendChild(createListItem).appendChild(searchSuggestion).appendChild(searchSuggestionRepository);


            }

        } else {
            console.log("The session data is empty... adding data")

            let getMarkdownFilesUrl;

            getMarkdownFilesUrl = [
                `https://api.github.com/search/code?q=language:markdown+org:bcc-code&per_page=100&page=1`,
                `https://api.github.com/search/code?q=language:markdown+org:bcc-code&per_page=100&page=2`,
                `https://api.github.com/search/code?q=language:markdown+org:bcc-code&per_page=100&page=3`,
                `https://api.github.com/search/code?q=language:markdown+org:bcc-code&per_page=100&page=4`
            ];

            let data;
            let urlNumber = 1;

            for (const url of getMarkdownFilesUrl) {

                const getMarkdownData = await fetch(url).then(response => response.json()).catch(error => console.log(error));
                for (data of getMarkdownData.items) {

                    const markdownRepositoryData = data.repository;
                    const markdownRepositoryName = markdownRepositoryData.name;
                    const markdownFileName = data.name;
                    const markdownFilePath = data.path;

                    const saveToSession = {
                        markdownRepositoryName,
                        markdownFileName,
                        markdownFilePath
                    }
                    
                    sessionStorage.setItem(urlNumber, JSON.stringify(saveToSession));
                    const sliceFilePath = markdownFilePath.slice(0, -3);

                    const markdownPageUrl = `/${markdownRepositoryName}/${sliceFilePath}.html`;

                    let createListItem = document.createElement("li");
                    let searchSuggestion = document.createElement("a");
                    let searchSuggestionRepository = document.createElement("span");

                    createListItem.className = "search_suggestion";

                    searchSuggestion.setAttribute("href", `${markdownPageUrl}`);
                    searchSuggestion.innerText = `${markdownFileName}`;

                    searchSuggestionRepository.className = "search_suggestion";
                    searchSuggestionRepository.innerText = `${markdownRepositoryName}`;

                    newElementsLocation.appendChild(createListItem).appendChild(searchSuggestion);
                    newElementsLocation.appendChild(createListItem).appendChild(searchSuggestion).appendChild(searchSuggestionRepository);

                    urlNumber++
                }

            }

            console.log("Data added")

        }


    }

    listMarkdownFiles();


</script>